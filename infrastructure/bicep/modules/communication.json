{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "4440018691352171398"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "metadata": {
        "description": "Environment name"
      }
    },
    "emailDomain": {
      "type": "string",
      "metadata": {
        "description": "Custom domain for email (e.g., augeo.app)"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Resource tags"
      }
    }
  },
  "variables": {
    "senderAddresses": [
      {
        "address": "[format('noreply@{0}', parameters('emailDomain'))]",
        "displayName": "Augeo Platform"
      },
      {
        "address": "[format('support@{0}', parameters('emailDomain'))]",
        "displayName": "Augeo Support"
      },
      {
        "address": "[format('billing@{0}', parameters('emailDomain'))]",
        "displayName": "Augeo Billing"
      },
      {
        "address": "[format('notifications@{0}', parameters('emailDomain'))]",
        "displayName": "Augeo Notifications"
      }
    ]
  },
  "resources": [
    {
      "type": "Microsoft.Communication/communicationServices",
      "apiVersion": "2023-04-01",
      "name": "[format('augeo-{0}-acs', parameters('environment'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "dataLocation": "United States"
      }
    },
    {
      "type": "Microsoft.Communication/emailServices",
      "apiVersion": "2023-04-01",
      "name": "[format('augeo-{0}-email', parameters('environment'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "dataLocation": "United States"
      }
    },
    {
      "condition": "[equals(parameters('environment'), 'production')]",
      "type": "Microsoft.Communication/emailServices/domains",
      "apiVersion": "2023-04-01",
      "name": "[format('{0}/{1}', format('augeo-{0}-email', parameters('environment')), parameters('emailDomain'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "domainManagement": "CustomerManaged",
        "userEngagementTracking": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Communication/emailServices', format('augeo-{0}-email', parameters('environment')))]"
      ]
    },
    {
      "condition": "[not(equals(parameters('environment'), 'production'))]",
      "type": "Microsoft.Communication/emailServices/domains",
      "apiVersion": "2023-04-01",
      "name": "[format('{0}/{1}', format('augeo-{0}-email', parameters('environment')), 'AzureManagedDomain')]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "domainManagement": "AzureManaged",
        "userEngagementTracking": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Communication/emailServices', format('augeo-{0}-email', parameters('environment')))]"
      ]
    },
    {
      "type": "Microsoft.Communication/communicationServices/domains",
      "apiVersion": "2023-04-01",
      "name": "[format('{0}/{1}', format('augeo-{0}-acs', parameters('environment')), if(equals(parameters('environment'), 'production'), parameters('emailDomain'), 'AzureManagedDomain'))]",
      "properties": {
        "domainResourceId": "[if(equals(parameters('environment'), 'production'), resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), parameters('emailDomain')), resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), 'AzureManagedDomain'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), 'AzureManagedDomain')]",
        "[resourceId('Microsoft.Communication/communicationServices', format('augeo-{0}-acs', parameters('environment')))]",
        "[resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), parameters('emailDomain'))]"
      ]
    }
  ],
  "outputs": {
    "communicationServiceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Communication/communicationServices', format('augeo-{0}-acs', parameters('environment')))]"
    },
    "communicationServiceName": {
      "type": "string",
      "value": "[format('augeo-{0}-acs', parameters('environment'))]"
    },
    "communicationServiceEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Communication/communicationServices', format('augeo-{0}-acs', parameters('environment'))), '2023-04-01').hostName]"
    },
    "communicationServiceConnectionString": {
      "type": "string",
      "value": "[listKeys(resourceId('Microsoft.Communication/communicationServices', format('augeo-{0}-acs', parameters('environment'))), '2023-04-01').primaryConnectionString]"
    },
    "emailServiceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Communication/emailServices', format('augeo-{0}-email', parameters('environment')))]"
    },
    "emailServiceName": {
      "type": "string",
      "value": "[format('augeo-{0}-email', parameters('environment'))]"
    },
    "emailDomainId": {
      "type": "string",
      "value": "[if(equals(parameters('environment'), 'production'), resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), parameters('emailDomain')), resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), 'AzureManagedDomain'))]"
    },
    "emailDomainName": {
      "type": "string",
      "value": "[if(equals(parameters('environment'), 'production'), parameters('emailDomain'), 'AzureManagedDomain')]"
    },
    "emailDomainStatus": {
      "type": "string",
      "value": "[if(equals(parameters('environment'), 'production'), reference(resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), parameters('emailDomain')), '2023-04-01').verificationStates.Domain.status, 'Verified')]"
    },
    "dnsRecordsRequired": {
      "type": "object",
      "value": "[if(equals(parameters('environment'), 'production'), createObject('verification', createObject('type', 'TXT', 'name', '@', 'value', reference(resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), parameters('emailDomain')), '2023-04-01').verificationStates.Domain.verificationToken, 'ttl', 3600), 'spf', createObject('type', 'TXT', 'name', '@', 'value', 'v=spf1 include:spf.protection.outlook.com include:spf.azurecomm.net ~all', 'ttl', 3600), 'dmarc', createObject('type', 'TXT', 'name', '_dmarc', 'value', format('v=DMARC1; p=quarantine; rua=mailto:dmarc@{0}; pct=100; fo=1', parameters('emailDomain')), 'ttl', 3600), 'dkim1', createObject('type', 'CNAME', 'name', 'selector1-azurecomm-prod-net._domainkey', 'value', reference(resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), parameters('emailDomain')), '2023-04-01').verificationStates.DKIM.domainKey1, 'ttl', 3600), 'dkim2', createObject('type', 'CNAME', 'name', 'selector2-azurecomm-prod-net._domainkey', 'value', reference(resourceId('Microsoft.Communication/emailServices/domains', format('augeo-{0}-email', parameters('environment')), parameters('emailDomain')), '2023-04-01').verificationStates.DKIM.domainKey2, 'ttl', 3600)), createObject())]"
    },
    "senderAddresses": {
      "type": "array",
      "value": "[variables('senderAddresses')]"
    },
    "configurationInstructions": {
      "type": "string",
      "value": "[if(equals(parameters('environment'), 'production'), 'Azure Communication Services Email Domain Configuration:\n\n1. Add DNS Records (required for verification and authentication):\n   - TXT @ : ${emailDomainConfig.properties.verificationStates.Domain.verificationToken}\n   - TXT @ : v=spf1 include:spf.azurecomm.net ~all\n   - TXT _dmarc : v=DMARC1; p=quarantine; rua=mailto:dmarc@${emailDomain}\n   - CNAME selector1-azurecomm-prod-net._domainkey : ${emailDomainConfig.properties.verificationStates.DKIM.domainKey1}\n   - CNAME selector2-azurecomm-prod-net._domainkey : ${emailDomainConfig.properties.verificationStates.DKIM.domainKey2}\n\n2. Wait 15-30 minutes for DNS propagation\n\n3. Verify domain in Azure Portal:\n   Navigate to Email Services → Domains → Verify\n\n4. Test email delivery:\n   Send test email from noreply@${emailDomain}\n   Check mail-tester.com for authentication score\n\n5. Configure sender addresses in application\n', 'Using Azure-managed domain for non-production environment')]"
    }
  }
}